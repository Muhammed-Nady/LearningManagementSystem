@model LearningManagementSystem.MVC.Models.StudentDashboardViewModel
@{
    ViewData["Title"] = "My Dashboard";
}

<div class="container my-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="fw-bold">Welcome back! ??</h1>
    </div>

    <!-- Stats Cards -->
    <div class="row g-3 mb-5">
        <div class="col-md-3">
        <div class="card border-0 shadow-sm h-100">
    <div class="card-body text-center p-4">
           <div class="mb-3" style="font-size: 3rem; color: #667eea;">
     <i class="bi bi-book"></i>
  </div>
   <h3 class="fw-bold mb-1" id="totalCourses">0</h3>
          <p class="text-muted mb-0">Enrolled Courses</p>
            </div>
            </div>
        </div>
        <div class="col-md-3">
     <div class="card border-0 shadow-sm h-100">
     <div class="card-body text-center p-4">
         <div class="mb-3" style="font-size: 3rem; color: #10B981;">
      <i class="bi bi-check-circle"></i>
        </div>
          <h3 class="fw-bold mb-1" id="completedCourses">0</h3>
           <p class="text-muted mb-0">Completed</p>
       </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
    <div class="card-body text-center p-4">
   <div class="mb-3" style="font-size: 3rem; color: #F59E0B;">
          <i class="bi bi-clock-history"></i>
         </div>
           <h3 class="fw-bold mb-1"><span id="totalHours">0</span>h</h3>
            <p class="text-muted mb-0">Hours Learned</p>
    </div>
   </div>
        </div>
        <div class="col-md-3">
<div class="card border-0 shadow-sm h-100">
     <div class="card-body text-center p-4">
 <div class="mb-3" style="font-size: 3rem; color: #667eea;">
          <i class="bi bi-graph-up"></i>
              </div>
        <h3 class="fw-bold mb-1"><span id="avgProgress">0</span>%</h3>
      <p class="text-muted mb-0">Avg Progress</p>
   </div>
  </div>
        </div>
    </div>

    <!-- Continue Learning -->
    <div class="mb-5">
        <div class="d-flex justify-content-between align-items-center mb-3">
     <h3 class="h4 fw-bold mb-0">Continue Learning</h3>
       <a asp-controller="Student" asp-action="MyCourses" class="small">View all ?</a>
        </div>

        <div id="continueLearning" class="row g-3">
            <!-- Dynamic content -->
            <div class="col-12 text-center text-muted py-5">
             <i class="bi bi-inbox" style="font-size: 3rem;"></i>
     <p class="mt-3">No courses in progress yet. <a asp-controller="Courses" asp-action="Index">Browse courses</a></p>
 </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
const API_BASE = (typeof AUTH_CONFIG !== 'undefined' && AUTH_CONFIG.API_URL) ? AUTH_CONFIG.API_URL : 'https://localhost:7000/api';

        document.addEventListener('DOMContentLoaded', async function() {
      if (!requireAuth()) return;

       const token = getToken();
 const user = getUser();

            try {
       // Fetch user's enrollments
       const response = await fetch(`${API_BASE}/enrollments/my-enrollments`, {
          headers: { 'Authorization': `Bearer ${token}` }
});

                if (response.ok) {
        const result = await response.json();
          const enrollments = result.data || [];

        // Calculate stats
   const total = enrollments.length;
           const completed = enrollments.filter(e => e.status === 'Completed').length;
       const avgProgress = total > 0 ? (enrollments.reduce((sum, e) => sum + e.progressPercentage, 0) / total).toFixed(0) : 0;

   document.getElementById('totalCourses').textContent = total;
       document.getElementById('completedCourses').textContent = completed;
    document.getElementById('avgProgress').textContent = avgProgress;

        // Display in-progress courses
 const inProgress = enrollments.filter(e => e.status === 'Active' && e.progressPercentage > 0);
              if (inProgress.length > 0) {
       displayContinueLearning(inProgress.slice(0, 3));
   }
      }
            } catch (error) {
                console.error('Failed to load dashboard data', error);
            }
  });

        function displayContinueLearning(enrollments) {
        const container = document.getElementById('continueLearning');
    container.innerHTML = '';

   enrollments.forEach(enrollment => {
        const col = document.createElement('div');
    col.className = 'col-md-4';
        col.innerHTML = `
             <div class="card h-100 border-0 shadow-sm">
     <img src="${enrollment.course?.thumbnailUrl || '/images/course-placeholder.png'}" class="card-img-top" style="height:180px;object-fit:cover;" />
            <div class="card-body">
     <h5 class="card-title">${enrollment.course?.title || 'Course'}</h5>
   <p class="text-muted small mb-3">${enrollment.course?.instructorName || ''}</p>
         <div class="mb-3">
          <div class="d-flex justify-content-between small mb-1">
           <span>Progress</span>
     <span class="fw-semibold">${enrollment.progressPercentage.toFixed(0)}%</span>
 </div>
            <div class="progress" style="height:8px;">
   <div class="progress-bar" style="width:${enrollment.progressPercentage}%;background:linear-gradient(90deg,#10B981,#059669);"></div>
             </div>
 </div>
   <a href="/student/learn/${enrollment.courseId}" class="btn btn-primary w-100">Continue Learning</a>
              </div>
          </div>
          `;
     container.appendChild(col);
 });
      }
  </script>
}
