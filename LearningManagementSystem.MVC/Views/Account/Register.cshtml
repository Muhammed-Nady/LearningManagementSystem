@model LearningManagementSystem.MVC.Models.RegisterViewModel
@{
    ViewData["Title"] = "Register";
}

<div class="container mt-5 mb-5">
    <div class="row justify-content-center">
        <div class="col-md-7">
            <div class="card shadow-lg border-0">
                <div class="card-body p-5">
                    <div class="text-center mb-4">
                        <div class="mb-3">
                            <i class="bi bi-person-plus-fill" style="font-size: 3rem; color: #667eea;"></i>
                        </div>
                        <h2 class="fw-bold" style="color: #1F2937;">Create Your Account</h2>
                        <p class="text-muted">Join thousands of learners worldwide</p>
                    </div>

                    <div id="errorMessage" class="alert alert-danger d-none" role="alert" style="background-color: #FEE2E2; border: 1px solid #F87171; color: #991B1B; border-radius: 8px;"></div>

                    <form id="registerForm" novalidate>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="FirstName" class="form-label" style="color: #374151; font-weight: 600;"></label>
                                <input asp-for="FirstName" class="form-control form-control-lg" placeholder="First name" style="border: 2px solid #E5E7EB; border-radius: 10px;" />
                                <span asp-validation-for="FirstName" class="text-danger small"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="LastName" class="form-label" style="color: #374151; font-weight: 600;"></label>
                                <input asp-for="LastName" class="form-control form-control-lg" placeholder="Last name" style="border: 2px solid #E5E7EB; border-radius: 10px;" />
                                <span asp-validation-for="LastName" class="text-danger small"></span>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Email" class="form-label" style="color: #374151; font-weight: 600;"></label>
                            <input asp-for="Email" class="form-control form-control-lg" placeholder="Enter your email" style="border: 2px solid #E5E7EB; border-radius: 10px;" />
                            <span asp-validation-for="Email" class="text-danger small"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Password" class="form-label" style="color: #374151; font-weight: 600;"></label>
                            <input asp-for="Password" class="form-control form-control-lg" placeholder="At least 6 characters" style="border: 2px solid #E5E7EB; border-radius: 10px;" />
                            <span asp-validation-for="Password" class="text-danger small"></span>
                        </div>

                        <div class="mb-4">
                            <label asp-for="ConfirmPassword" class="form-label" style="color: #374151; font-weight: 600;"></label>
                            <input asp-for="ConfirmPassword" class="form-control form-control-lg" placeholder="Re-enter password" style="border: 2px solid #E5E7EB; border-radius: 10px;" />
                            <span asp-validation-for="ConfirmPassword" class="text-danger small"></span>
                        </div>

                        <div class="mb-4 p-3" style="background-color: #F3F4F6; border-radius: 10px; border-left: 4px solid #667eea;">
                            <div class="form-check">
                                <input asp-for="RegisterAsInstructor" class="form-check-input" style="border: 2px solid #667eea; width: 20px; height: 20px;" />
                                <label asp-for="RegisterAsInstructor" class="form-check-label ms-2" style="color: #374151; font-weight: 500;">
                                    I want to teach courses (Register as Instructor)
                                </label>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary btn-lg w-100 mb-3" id="registerBtn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 10px; padding: 12px; font-weight: 600;">
                            <i class="bi bi-person-plus me-2"></i>Create Account
                        </button>

                        <div class="text-center mt-4">
                            <p class="text-muted mb-2">Already have an account?</p>
                            <a asp-controller="Account" asp-action="Login" class="text-decoration-none fw-semibold" style="color: #667eea;">Sign in here →</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
               const API_BASE = (typeof AUTH_CONFIG !== 'undefined' && AUTH_CONFIG.API_URL) ? AUTH_CONFIG.API_URL : 'https://localhost:7000/api';

        document.getElementById('registerForm').addEventListener('submit', async function(e) {
         e.preventDefault();

          const btn = document.getElementById('registerBtn');
              const errorDiv = document.getElementById('errorMessage');

          // Clear previous errors
         errorDiv.classList.add('d-none');

          // Get form data
           const firstName = document.getElementById('FirstName').value;
          const lastName = document.getElementById('LastName').value;
            const email = document.getElementById('Email').value;
          const password = document.getElementById('Password').value;
          const confirmPassword = document.getElementById('ConfirmPassword').value;
         const registerAsInstructor = document.getElementById('RegisterAsInstructor').checked;

          // Client-side validation
          if (password !== confirmPassword) {
          errorDiv.textContent = 'Passwords do not match';
            errorDiv.classList.remove('d-none');
          return;
        }

        // Disable button
             btn.disabled = true;
          btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Creating account...';

         try {
          const response = await fetch(`${API_BASE}/auth/register`, {
         method: 'POST',
                 headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
            email,
            password,
        firstName,
                 lastName,
           role: registerAsInstructor ? 2 : 3  // 2=Instructor, 3=Student
          })
           });

           const result = await response.json();

        if (response.ok && result.success) {
            // Save auth data using auth.js
            saveAuth(result.data.token, {
                 userId: result.data.userId,
          email: result.data.email,
          firstName: result.data.firstName,
           lastName: result.data.lastName,
           role: result.data.role,
         expiresAt: result.data.expiresAt
             });

          // Redirect to home
             window.location.href = '/';
            } else {
             errorDiv.textContent = result.message || 'Registration failed. Please try again.';
           errorDiv.classList.remove('d-none');
           }
                   } catch (error) {
          errorDiv.textContent = 'Unable to connect to server. Please try again.';
            errorDiv.classList.remove('d-none');
           } finally {
             btn.disabled = false;
           btn.innerHTML = '<i class="bi bi-person-plus me-2"></i>Create Account';
          }
        });
    </script>
}
